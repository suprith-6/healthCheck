name: Health Check Integration Tests

on: 
  push:
    branches: [main]
  pull_request:
    branches: [main]
    
    
jobs:

  test:

    runs-on: ubuntu-latest

    services:
    
      mysql:
        image: mysql:8  
        env:
          MYSQL_ROOT_PASSWORD: 1998@Pupss 
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Setup Node.js
      uses: actions/setup-node@v2
      with:
        node-version: 14
        
    - name: Install dependencies
      run: npm ci --no-package-lock

    - name: Zest installation
      run: npm install --save-dev jest

    - name: Supertest installation
      run: npm install --save-dev supertest

    - name: Babel installation for ES6
      run: npm install --save-dev babel-jest @babel/core @babel/preset-env

    - name: Start MySQL
      run: sudo systemctl start mysql

    - name: Verify MySQL status
      run: sudo systemctl status mysql
    
    - name: Run integration tests
      env:
        DATABASE_HOST: 127.0.0.1
        DATABASE_USER: root
        DATABASE_PASSWORD: 1998@Pupss
        DATABASE_DB: assignment1
      run: npm run test:integration
