name: Node.js CI

on: 
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  MYSQL_ROOT_PASSWORD: "1998@Pupss" 

jobs:

  test:

    runs-on: ubuntu-latest

    services:
      db:
        image: mysql
        env:
          MYSQL_ROOT_PASSWORD: ${{ env.MYSQL_ROOT_PASSWORD }}

    steps:
    
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Setup Node.js
      uses: actions/setup-node@v2

    - name: Install dependencies
      run: npm install

    - name: Verify MySQL is running
      run: |
        sudo service mysql status

    - name: Check port 
      run: |
        sudo lsof -i:3306

    - name: Test connectivity   
      run: |
        mysqladmin -u root -p${{ env.MYSQL_ROOT_PASSWORD }} ping

    - name: Start MySQL service
      run: | 
        sudo service mysql start

    - name: Create DB
      run: |
        mysql -u root -p ${{ env.MYSQL_ROOT_PASSWORD }} -e "CREATE DATABASE assignment1"

    - name: Run tests
      run: npm test

    - name: Start app
      run: npm start &
        
    - name: Test /healthz
      run: |
        if [ $(curl -s http://localhost:9000/healthz) = "200" ]; then
          echo "Health check passed"
        else
          echo "Health check failed"  
          exit 1
        fi
